###############################################################################
# Cheapest Energy Windows - Battery Control Automation Template
#
# This automation triggers on CEW state changes and allows you to control
# your battery system based on detected charging/discharging windows.
#
# To use this automation:
# 1. This file will be automatically created during setup if you choose to
# 2. Or manually: Copy this content to Configuration â†’ Automations â†’ Create
# 3. Add your battery control actions in each sequence section
#
# Note: This template has no default actions - you must configure your
# battery control commands based on your specific battery system.
###############################################################################

alias: CEW - Battery Control (Auto-Managed - DO NOT DELETE)
description: Control your home battery based on Cheapest Energy Windows calculations
mode: queued
max: 10

trigger:
  - platform: state
    entity_id: sensor.cew_today
    to: charge
    from:
    - discharge
    - discharge_aggressive
    - idle
    - 'off'
    id: charge_start
  - platform: state
    entity_id: sensor.cew_today
    to: discharge
    from:
    - charge
    - discharge_aggressive
    - idle
    - 'off'
    id: discharge_start
  - platform: state
    entity_id: sensor.cew_today
    to: discharge_aggressive
    from:
    - charge
    - discharge
    - idle
    - 'off'
    id: discharge_aggressive_start
  - platform: state
    entity_id: sensor.cew_today
    to: idle
    from:
    - charge
    - discharge
    - discharge_aggressive
    - 'off'
    id: idle_start
  - platform: state
    entity_id: sensor.cew_today
    to: 'off'
    from:
    - charge
    - discharge
    - discharge_aggressive
    - idle
    id: automation_disabled

# Filter out transitions from 'unavailable' state (happens during config changes/reloads)
condition:
  - condition: template
    value_template: '{{ trigger.from_state.state != ''unavailable'' }}'

action:
  - choose:
      #########################################################################
      # CHARGE State - Cheap energy window detected
      #########################################################################
      - conditions:
          - condition: trigger
            id: charge_start
        sequence:
          # Send notification if enabled
          - condition: and
            conditions:
              - condition: state
                entity_id: switch.cew_notifications_enabled
                state: 'on'
              - condition: state
                entity_id: switch.cew_notify_charging
                state: 'on'
              - condition: or
                conditions:
                  - condition: state
                    entity_id: switch.cew_quiet_hours_enabled
                    state: 'off'
                  - condition: template
                    value_template: >-
                      {% set now_time = now().strftime('%H:%M') %}
                      {% set quiet_start = states('time.cew_quiet_hours_start') %}
                      {% set quiet_end = states('time.cew_quiet_hours_end') %}
                      {{ now_time < quiet_start or now_time >= quiet_end }}
          - service: notify.notify
            data:
              title: "ðŸ”‹ CEW: Charging Mode Started"
              message: >-
                Current price: â‚¬{{ state_attr('sensor.cew_today', 'current_price') | float(0) | round(5) }}/kWh

                Avg cheap price: â‚¬{{ state_attr('sensor.cew_today', 'avg_cheap_price') | float(0) | round(5) }}/kWh

                Charge power: {{ states('number.cew_charge_power') }}W

                Spread: {{ state_attr('sensor.cew_today', 'spread_avg') | float(0) | round(1) }}%

          # Execute linked automation/script/scene if configured
          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {% set entity = states('text.cew_battery_charge_action') %}
                      {{ entity != 'not_configured' and entity != 'unknown' and entity != '' }}
                sequence:
                  - service: >
                      {% if states('text.cew_battery_charge_action').startswith('automation.') %}
                        automation.trigger
                      {% elif states('text.cew_battery_charge_action').startswith('script.') %}
                        script.turn_on
                      {% elif states('text.cew_battery_charge_action').startswith('scene.') %}
                        scene.turn_on
                      {% endif %}
                    target:
                      entity_id: "{{ states('text.cew_battery_charge_action') }}"
            default: []

      #########################################################################
      # DISCHARGE State - Expensive energy window detected
      #########################################################################
      - conditions:
          - condition: trigger
            id: discharge_start
        sequence:
          # Check SOC safety limits before discharge
          - choose:
              # Case 1: SOC safety enabled but sensor not configured
              - conditions:
                  - condition: state
                    entity_id: switch.cew_battery_use_soc_safety
                    state: 'on'
                  - condition: state
                    entity_id: text.cew_battery_soc_sensor
                    state: 'not_configured'
                sequence:
                  - condition: and
                    conditions:
                      - condition: state
                        entity_id: switch.cew_notifications_enabled
                        state: 'on'
                      - condition: or
                        conditions:
                          - condition: state
                            entity_id: switch.cew_quiet_hours_enabled
                            state: 'off'
                          - condition: template
                            value_template: >-
                              {% set now_time = now().strftime('%H:%M') %}
                              {% set quiet_start = states('time.cew_quiet_hours_start') %}
                              {% set quiet_end = states('time.cew_quiet_hours_end') %}
                              {{ now_time < quiet_start or now_time >= quiet_end }}
                  - service: notify.notify
                    data:
                      title: "âš ï¸ CEW: SOC Safety Misconfigured"
                      message: >-
                        Battery SOC Safety is enabled but battery sensor is not configured.

                        Please configure the battery SOC sensor in Settings or disable SOC Safety.
                  - stop: "SOC safety enabled but sensor not configured"

              # Case 2: SOC safety enabled and SOC below minimum
              - conditions:
                  - condition: state
                    entity_id: switch.cew_battery_use_soc_safety
                    state: 'on'
                  - condition: template
                    value_template: >-
                      {% set sensor = states('text.cew_battery_soc_sensor') %}
                      {% set min_soc = states('number.cew_battery_min_soc_discharge') | float(20) %}
                      {% set current_soc = states(sensor) | float(-1) %}
                      {{ sensor != 'not_configured' and current_soc >= 0 and current_soc <= min_soc }}
                sequence:
                  # Set mode to idle
                  - service: input_text.set_value
                    target:
                      entity_id: input_text.cew_current_mode
                    data:
                      value: 'idle'

                  # Send notification if enabled
                  - condition: and
                    conditions:
                      - condition: state
                        entity_id: switch.cew_notifications_enabled
                        state: 'on'
                      - condition: or
                        conditions:
                          - condition: state
                            entity_id: switch.cew_quiet_hours_enabled
                            state: 'off'
                          - condition: template
                            value_template: >-
                              {% set now_time = now().strftime('%H:%M') %}
                              {% set quiet_start = states('time.cew_quiet_hours_start') %}
                              {% set quiet_end = states('time.cew_quiet_hours_end') %}
                              {{ now_time < quiet_start or now_time >= quiet_end }}
                  - service: notify.notify
                    data:
                      title: "ðŸ”‹ CEW: Discharge Blocked by SOC Safety"
                      message: >-
                        {% set sensor = states('text.cew_battery_soc_sensor') %}
                        {% set min_soc = states('number.cew_battery_min_soc_discharge') | float(20) %}
                        {% set current_soc = states(sensor) | float(0) %}
                        Battery SOC ({{ current_soc }}%) is at or below minimum discharge limit ({{ min_soc }}%).

                        Mode set to idle to protect battery.
                  - stop: "SOC below minimum discharge threshold"

          # Send notification if enabled
          - condition: and
            conditions:
              - condition: state
                entity_id: switch.cew_notifications_enabled
                state: 'on'
              - condition: state
                entity_id: switch.cew_notify_discharge
                state: 'on'
              - condition: or
                conditions:
                  - condition: state
                    entity_id: switch.cew_quiet_hours_enabled
                    state: 'off'
                  - condition: template
                    value_template: >-
                      {% set now_time = now().strftime('%H:%M') %}
                      {% set quiet_start = states('time.cew_quiet_hours_start') %}
                      {% set quiet_end = states('time.cew_quiet_hours_end') %}
                      {{ now_time < quiet_start or now_time >= quiet_end }}
          - service: notify.notify
            data:
              title: "âš¡ CEW: Discharge Mode Started"
              message: >-
                Current price: â‚¬{{ state_attr('sensor.cew_today', 'current_price') | float(0) | round(5) }}/kWh

                Avg expensive price: â‚¬{{ state_attr('sensor.cew_today', 'avg_expensive_price') | float(0) | round(5) }}/kWh

                Discharge power: {{ states('number.cew_discharge_power') }}W

                Spread: {{ state_attr('sensor.cew_today', 'spread_avg') | float(0) | round(1) }}%

          # Execute linked automation/script/scene if configured
          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {% set entity = states('text.cew_battery_discharge_action') %}
                      {{ entity != 'not_configured' and entity != 'unknown' and entity != '' }}
                sequence:
                  - service: >
                      {% if states('text.cew_battery_discharge_action').startswith('automation.') %}
                        automation.trigger
                      {% elif states('text.cew_battery_discharge_action').startswith('script.') %}
                        script.turn_on
                      {% elif states('text.cew_battery_discharge_action').startswith('scene.') %}
                        scene.turn_on
                      {% endif %}
                    target:
                      entity_id: "{{ states('text.cew_battery_discharge_action') }}"
            default: []

      #########################################################################
      # AGGRESSIVE DISCHARGE State - Peak price period detected
      #########################################################################
      - conditions:
          - condition: trigger
            id: discharge_aggressive_start
        sequence:
          # Check SOC safety limits before aggressive discharge
          - choose:
              # Case 1: SOC safety enabled but sensor not configured
              - conditions:
                  - condition: state
                    entity_id: switch.cew_battery_use_soc_safety
                    state: 'on'
                  - condition: state
                    entity_id: text.cew_battery_soc_sensor
                    state: 'not_configured'
                sequence:
                  - condition: and
                    conditions:
                      - condition: state
                        entity_id: switch.cew_notifications_enabled
                        state: 'on'
                      - condition: or
                        conditions:
                          - condition: state
                            entity_id: switch.cew_quiet_hours_enabled
                            state: 'off'
                          - condition: template
                            value_template: >-
                              {% set now_time = now().strftime('%H:%M') %}
                              {% set quiet_start = states('time.cew_quiet_hours_start') %}
                              {% set quiet_end = states('time.cew_quiet_hours_end') %}
                              {{ now_time < quiet_start or now_time >= quiet_end }}
                  - service: notify.notify
                    data:
                      title: "âš ï¸ CEW: SOC Safety Misconfigured"
                      message: >-
                        Battery SOC Safety is enabled but battery sensor is not configured.

                        Please configure the battery SOC sensor in Settings or disable SOC Safety.
                  - stop: "SOC safety enabled but sensor not configured"

              # Case 2: SOC safety enabled and SOC below minimum for aggressive discharge
              - conditions:
                  - condition: state
                    entity_id: switch.cew_battery_use_soc_safety
                    state: 'on'
                  - condition: template
                    value_template: >-
                      {% set sensor = states('text.cew_battery_soc_sensor') %}
                      {% set min_soc = states('number.cew_battery_min_soc_aggressive_discharge') | float(30) %}
                      {% set current_soc = states(sensor) | float(-1) %}
                      {{ sensor != 'not_configured' and current_soc >= 0 and current_soc <= min_soc }}
                sequence:
                  # Set mode to idle
                  - service: input_text.set_value
                    target:
                      entity_id: input_text.cew_current_mode
                    data:
                      value: 'idle'

                  # Send notification if enabled
                  - condition: and
                    conditions:
                      - condition: state
                        entity_id: switch.cew_notifications_enabled
                        state: 'on'
                      - condition: or
                        conditions:
                          - condition: state
                            entity_id: switch.cew_quiet_hours_enabled
                            state: 'off'
                          - condition: template
                            value_template: >-
                              {% set now_time = now().strftime('%H:%M') %}
                              {% set quiet_start = states('time.cew_quiet_hours_start') %}
                              {% set quiet_end = states('time.cew_quiet_hours_end') %}
                              {{ now_time < quiet_start or now_time >= quiet_end }}
                  - service: notify.notify
                    data:
                      title: "ðŸ”‹ CEW: Aggressive Discharge Blocked by SOC Safety"
                      message: >-
                        {% set sensor = states('text.cew_battery_soc_sensor') %}
                        {% set min_soc = states('number.cew_battery_min_soc_aggressive_discharge') | float(30) %}
                        {% set current_soc = states(sensor) | float(0) %}
                        Battery SOC ({{ current_soc }}%) is at or below minimum aggressive discharge limit ({{ min_soc }}%).

                        Mode set to idle to protect battery.
                  - stop: "SOC below minimum aggressive discharge threshold"

          # Send notification if enabled
          - condition: and
            conditions:
              - condition: state
                entity_id: switch.cew_notifications_enabled
                state: 'on'
              - condition: state
                entity_id: switch.cew_notify_discharge_aggressive
                state: 'on'
              - condition: or
                conditions:
                  - condition: state
                    entity_id: switch.cew_quiet_hours_enabled
                    state: 'off'
                  - condition: template
                    value_template: >-
                      {% set now_time = now().strftime('%H:%M') %}
                      {% set quiet_start = states('time.cew_quiet_hours_start') %}
                      {% set quiet_end = states('time.cew_quiet_hours_end') %}
                      {{ now_time < quiet_start or now_time >= quiet_end }}
          - service: notify.notify
            data:
              title: "ðŸš¨ CEW: Aggressive Discharge Started"
              message: >-
                Current price: â‚¬{{ state_attr('sensor.cew_today', 'current_price') | float(0) | round(5) }}/kWh

                Avg expensive price: â‚¬{{ state_attr('sensor.cew_today', 'avg_expensive_price') | float(0) | round(5) }}/kWh

                Max discharge power: {{ states('number.cew_discharge_power') }}W

                Spread: {{ state_attr('sensor.cew_today', 'spread_avg') | float(0) | round(1) }}%

          # Execute linked automation/script/scene if configured
          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {% set entity = states('text.cew_battery_aggressive_discharge_action') %}
                      {{ entity != 'not_configured' and entity != 'unknown' and entity != '' }}
                sequence:
                  - service: >
                      {% if states('text.cew_battery_aggressive_discharge_action').startswith('automation.') %}
                        automation.trigger
                      {% elif states('text.cew_battery_aggressive_discharge_action').startswith('script.') %}
                        script.turn_on
                      {% elif states('text.cew_battery_aggressive_discharge_action').startswith('scene.') %}
                        scene.turn_on
                      {% endif %}
                    target:
                      entity_id: "{{ states('text.cew_battery_aggressive_discharge_action') }}"
            default: []

      #########################################################################
      # IDLE State - No charge or discharge window active
      #########################################################################
      - conditions:
          - condition: trigger
            id: idle_start
        sequence:
          # Send notification if enabled
          - condition: and
            conditions:
              - condition: state
                entity_id: switch.cew_notifications_enabled
                state: 'on'
              - condition: state
                entity_id: switch.cew_notify_idle
                state: 'on'
              - condition: or
                conditions:
                  - condition: state
                    entity_id: switch.cew_quiet_hours_enabled
                    state: 'off'
                  - condition: template
                    value_template: >-
                      {% set now_time = now().strftime('%H:%M') %}
                      {% set quiet_start = states('time.cew_quiet_hours_start') %}
                      {% set quiet_end = states('time.cew_quiet_hours_end') %}
                      {{ now_time < quiet_start or now_time >= quiet_end }}
          - service: notify.notify
            data:
              title: "ðŸ’¤ CEW: Normal/idle Mode Started"
              message: >-
                Current price: â‚¬{{ state_attr('sensor.cew_today', 'current_price') | float(0) | round(5) }}/kWh

                Spread: {{ state_attr('sensor.cew_today', 'spread_avg') | float(0) | round(1) }}%

          # Execute linked automation/script/scene if configured
          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {% set entity = states('text.cew_battery_idle_action') %}
                      {{ entity != 'not_configured' and entity != 'unknown' and entity != '' }}
                sequence:
                  - service: >
                      {% if states('text.cew_battery_idle_action').startswith('automation.') %}
                        automation.trigger
                      {% elif states('text.cew_battery_idle_action').startswith('script.') %}
                        script.turn_on
                      {% elif states('text.cew_battery_idle_action').startswith('scene.') %}
                        scene.turn_on
                      {% endif %}
                    target:
                      entity_id: "{{ states('text.cew_battery_idle_action') }}"
            default: []

      #########################################################################
      # OFF State - CEW automation disabled
      #########################################################################
      - conditions:
          - condition: trigger
            id: automation_disabled
        sequence:
          # Send notification if enabled
          - condition: and
            conditions:
              - condition: state
                entity_id: switch.cew_notifications_enabled
                state: 'on'
              - condition: state
                entity_id: switch.cew_notify_automation_disabled
                state: 'on'
              - condition: or
                conditions:
                  - condition: state
                    entity_id: switch.cew_quiet_hours_enabled
                    state: 'off'
                  - condition: template
                    value_template: >-
                      {% set now_time = now().strftime('%H:%M') %}
                      {% set quiet_start = states('time.cew_quiet_hours_start') %}
                      {% set quiet_end = states('time.cew_quiet_hours_end') %}
                      {{ now_time < quiet_start or now_time >= quiet_end }}
          - service: notify.notify
            data:
              title: "â›” CEW: Automation Disabled"
              message: >-
                CEW automation has been turned off.

          # ADD YOUR BATTERY MANUAL MODE ACTIONS HERE (optional)
          # Examples:
          # - service: switch.turn_off
          #   target:
          #     entity_id: switch.your_battery_auto_mode

    default: []

###############################################################################
# CUSTOMIZATION GUIDE:
#
# 1. Add quiet hours condition (optional):
#    Add this to the top-level 'condition:' section:
#    - condition: template
#      after: "07:00:00"
#      before: "22:00:00"
#
# 2. Add battery SOC check (if you have battery sensors):
#    Add this to specific sequences (e.g., charge_start):
#    - condition: numeric_state
#      entity_id: sensor.your_battery_soc
#      below: 95  # Don't charge if battery is already full
#
# 3. Add notifications (optional):
#    - service: notify.mobile_app_your_phone
#      data:
#        title: "Battery Status"
#        message: "Current price: â‚¬{{ state_attr('sensor.cew_today', 'current_price') | round(5) }}/kWh"
#
# 4. Connect to your battery system:
#    Replace the example actions with service calls specific to your battery:
#    - Zendure: Use zendure_solarflow integration services
#    - Tesla Powerwall: Use tesla_custom integration services
#    - SolarEdge: Use solaredge_modbus integration services
#    - Generic MQTT: Use mqtt.publish service
#
# 5. Use CEW sensor attributes in your actions:
#    - Current price: {{ state_attr('sensor.cew_today', 'current_price') }}
#    - Charge power: {{ states('number.cew_charge_power') }}
#    - Discharge power: {{ states('number.cew_discharge_power') }}
#    - Spread: {{ state_attr('sensor.cew_today', 'spread_avg') }}
#    - Window times: {{ state_attr('sensor.cew_today', 'cheapest_times') }}
#
###############################################################################
